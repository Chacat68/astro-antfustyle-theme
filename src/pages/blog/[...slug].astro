---
import RenderPost from '~/components/views/RenderPost.astro'
import { getCollection, getEntry } from 'astro:content'

import { getLocale } from '~/i18n/translate'

export async function getStaticPaths() {
  // Use zh posts as the source of truth for slugs.
  const posts = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true
  })

  return posts.map((post) => ({
    params: { slug: post.id },
  }))
}

const locale = getLocale(Astro.currentLocale)
const slug = Astro.params.slug
if (!slug) throw new Error('Missing blog post slug')

let enPost = null
if (locale === 'en') {
  try {
    enPost = await getEntry('blog_en', slug)
  } catch {
    enPost = null
  }
}

const post = enPost ?? (await getEntry('blog', slug))

if (!post) throw new Error(`Blog post not found: ${slug}`)
---

<RenderPost {post} isCommentable={true} />
