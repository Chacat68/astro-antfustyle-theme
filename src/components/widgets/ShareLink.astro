---
import Link from '~/components/base/Link.astro'
import { getLocale, useTranslations } from '~/i18n/translate'
import type { ShareConfig } from '~/types'

interface ShareLink {
  baseUrl: string
  formatUrl: (postUrl: URL, config?: [boolean, string?]) => string
  label: string
  title: string
}

interface Props {
  config: ShareConfig
}

const { config } = Astro.props
const postUrl = Astro.url

const locale = getLocale(Astro.currentLocale)
const t = useTranslations(locale)

const buildShareText = (url: URL, cfg?: [boolean, string?]) => {
  const author = cfg?.[1]
  return author
    ? t('share.readingWithAuthor', { author, url: url.toString() })
    : t('share.reading', { url: url.toString() })
}

const SHARE_LINKS: Record<string, ShareLink> = {
  twitter: {
    baseUrl: 'https://twitter.com/intent/tweet?text=',
    formatUrl: (url, cfg) =>
      `${SHARE_LINKS.twitter.baseUrl}${encodeURIComponent(
        buildShareText(url, cfg)
      )}`,
    label: 'twitter',
    title: t('share.title.twitter'),
  },
  bluesky: {
    baseUrl: 'https://bsky.app/intent/compose?text=',
    formatUrl: (url, cfg) =>
      `${SHARE_LINKS.bluesky.baseUrl}${encodeURIComponent(
        buildShareText(url, cfg)
      )}`,
    label: 'bluesky',
    title: t('share.title.bluesky'),
  },
  mastodon: {
    baseUrl: 'https://elk.zone/intent/post?text=',
    formatUrl: (url, cfg) =>
      `${SHARE_LINKS.mastodon.baseUrl}${encodeURIComponent(
        buildShareText(url, cfg)
      )}`,
    label: 'mastodon',
    title: t('share.title.mastodon'),
  },
  facebook: {
    baseUrl: 'https://www.facebook.com/sharer.php?u=',
    formatUrl: (url) => `${SHARE_LINKS.facebook.baseUrl}${url}`,
    label: 'facebook',
    title: t('share.title.facebook'),
  },
  pinterest: {
    baseUrl: 'https://pinterest.com/pin/create/button/?url=',
    formatUrl: (url) => `${SHARE_LINKS.pinterest.baseUrl}${url}`,
    label: 'pinterest',
    title: t('share.title.pinterest'),
  },
  reddit: {
    baseUrl: 'https://www.reddit.com/submit?url=',
    formatUrl: (url) => `${SHARE_LINKS.reddit.baseUrl}${url}`,
    label: 'reddit',
    title: t('share.title.reddit'),
  },
  telegram: {
    baseUrl: 'https://t.me/share/url?url=',
    formatUrl: (url) => `${SHARE_LINKS.telegram.baseUrl}${url}`,
    label: 'telegram',
    title: t('share.title.telegram'),
  },
  whatsapp: {
    baseUrl: 'https://wa.me/?text=',
    formatUrl: (url) => `${SHARE_LINKS.whatsapp.baseUrl}${url}`,
    label: 'whatsapp',
    title: t('share.title.whatsapp'),
  },
  email: {
    baseUrl: 'mailto:?subject=See%20this%20post&body=',
    formatUrl: (url) => `${SHARE_LINKS.email.baseUrl}${url}`,
    label: 'email',
    title: t('share.title.email'),
  },
}

const links = Object.entries(config)
  .filter(([key, value]) => value && key in SHARE_LINKS)
  .map(([key, cfg]) => {
    const linkConfig = SHARE_LINKS[key]
    return {
      url: linkConfig.formatUrl(postUrl, cfg),
      label: linkConfig.label,
      title: linkConfig.title,
    }
  })
---

<span class="font-mono op-50">&gt; </span>
<span class="op-50">{t('share.shareOn')}</span>
{
  links.map((link, idx) => (
    <>
      <Link class="op-50!" href={link.url} title={link.title} external={true}>
        {link.label}
      </Link>
      {idx < links.length - 1 && <span class="op-25">/</span>}
    </>
  ))
}
