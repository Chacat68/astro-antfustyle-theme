---
import { getFilteredPosts } from '~/utils/data'

interface Props {
  year?: number
}

const currentYear = new Date().getFullYear()
const { year: yearProp } = Astro.props
const urlYearRaw = Astro.url?.searchParams.get('year')
const urlYear = urlYearRaw ? Number(urlYearRaw) : NaN
const selectedYear =
  typeof yearProp === 'number'
    ? yearProp
    : Number.isFinite(urlYear) && urlYear >= 1970 && urlYear <= 2100
      ? urlYear
      : currentYear

function makeYearUrl(targetYear: number) {
  const url = new URL(Astro.url)
  url.searchParams.set('year', String(targetYear))
  return `${url.pathname}${url.search}${url.hash}`
}

const prevYearUrl = makeYearUrl(selectedYear - 1)
const nextYearUrl = makeYearUrl(selectedYear + 1)

// Get all blog posts
const posts = await getFilteredPosts('blog')

const postsInYear = posts.filter((post) => {
  const pubDate = post.data.pubDate || post.data.published
  return pubDate ? pubDate.getFullYear() === selectedYear : false
})
const postsInYearCount = postsInYear.length

// Calculate total word count
let totalWordCount = 0
for (const post of postsInYear) {
  const bodyContent = post.body
  const wordCount = bodyContent?.trim()
    ? bodyContent.trim().split(/\s+/).filter(Boolean).length
    : 0
  totalWordCount += wordCount
}

// Create a map of dates to post counts (selected year)
const dateMap = new Map<string, number>()

postsInYear.forEach((post) => {
  const pubDate = post.data.pubDate || post.data.published
  if (pubDate) {
    const dateStr = pubDate.toISOString().split('T')[0]
    const count = dateMap.get(dateStr) || 0
    dateMap.set(dateStr, count + 1)
  }
})

// Generate heatmap data for the year
const startDate = new Date(selectedYear, 0, 1)
const endDate = new Date(selectedYear, 11, 31)

// Adjust to start on Sunday
const displayStartDate = new Date(startDate)
displayStartDate.setDate(displayStartDate.getDate() - displayStartDate.getDay())

// Adjust to end on Saturday
const displayEndDate = new Date(endDate)
displayEndDate.setDate(displayEndDate.getDate() + (6 - displayEndDate.getDay()))

// Get all weeks data
const weeks: { date: Date; count: number }[][] = []
let currentWeek: { date: Date; count: number }[] = []
const currentDate = new Date(displayStartDate)

while (currentDate <= displayEndDate) {
  const dateStr = currentDate.toISOString().split('T')[0]
  const count = dateMap.get(dateStr) || 0

  currentWeek.push({
    date: new Date(currentDate),
    count,
  })

  if (currentWeek.length === 7) {
    weeks.push(currentWeek)
    currentWeek = []
  }

  currentDate.setDate(currentDate.getDate() + 1)
}

if (currentWeek.length > 0) {
  weeks.push(currentWeek)
}

// Get intensity level (0-4)
function getIntensity(count: number) {
  if (count === 0) return 0
  if (count === 1) return 1
  if (count === 2) return 2
  if (count === 3) return 3
  return 4
}

// Get max count for scaling
// Month labels
const monthNames = [
  '1月',
  '2月',
  '3月',
  '4月',
  '5月',
  '6月',
  '7月',
  '8月',
  '9月',
  '10月',
  '11月',
  '12月',
]
const monthLabelDates: { month: string; weekIndex: number }[] = []
let lastMonth = -1

weeks.forEach((week, index) => {
  const month = week[0].date.getMonth()
  if (month !== lastMonth) {
    monthLabelDates.push({
      month: monthNames[month],
      weekIndex: index,
    })
    lastMonth = month
  }
})
---

<div class="article-heatmap">
  <div class="heatmap-header">
    <div class="heatmap-title">
      <h3>{selectedYear} 年文章热力图</h3>
      <nav class="year-switch" aria-label="年份切换">
        <a class="year-btn" href={prevYearUrl}>上一年</a>
        <a class="year-btn" href={nextYearUrl}>下一年</a>
      </nav>
    </div>
    <div class="heatmap-legend">
      <span class="legend-label">少</span>
      <div class="legend-boxes">
        {
          [0, 1, 2, 3, 4].map((intensity) => (
            <div class={`legend-box intensity-${intensity}`} />
          ))
        }
      </div>
      <span class="legend-label">多</span>
    </div>
  </div>

  <div class="heatmap-container">
    <div class="heatmap-labels">
      <div class="day-labels">
        <div class="day-label">一</div>
        <div class="day-label"></div>
        <div class="day-label">三</div>
        <div class="day-label"></div>
        <div class="day-label">五</div>
        <div class="day-label"></div>
      </div>
    </div>

    <div class="heatmap-wrapper" style={`--weeks: ${weeks.length}`}>
      <div class="month-labels">
        {
          monthLabelDates.map((item) => (
            <div
              class="month-label"
              style={`grid-column: ${item.weekIndex + 1}`}
            >
              {item.month}
            </div>
          ))
        }
      </div>

      <div class="heatmap-grid">
        {
          weeks.map((week) =>
            week.map((day) => {
              const dateStr = day.date.toISOString().split('T')[0]
              const intensity = getIntensity(day.count)
              const isCurrentYear = day.date.getFullYear() === selectedYear

              return (
                <div
                  class={`heatmap-cell intensity-${intensity} ${!isCurrentYear ? 'outside-year' : ''}`}
                  title={`${dateStr}: ${day.count} 篇`}
                />
              )
            })
          )
        }
      </div>
    </div>
  </div>

  <div class="heatmap-stats">
    <span>{selectedYear} 年共 {postsInYearCount} 篇</span>
    <span>单日最多 {Math.max(...Array.from(dateMap.values()), 0)} 篇</span>
    <span>总字数 {totalWordCount.toLocaleString()}</span>
  </div>
</div>

<style>
  .article-heatmap {
    margin: 2rem 0;
    padding: 1.5rem;
    border-radius: 0.5rem;
    background: var(--color-bg-secondary, rgba(0, 0, 0, 0.05));
    --heatmap-cell: clamp(0.3rem, 0.9vw, 0.65rem);
    --heatmap-gap: clamp(0.08rem, 0.2vw, 0.18rem);
    --heatmap-label-width: clamp(1.8rem, 6vw, 2.5rem);
    --heatmap-label-pad: clamp(0.25rem, 1vw, 0.5rem);
  }

  :global(:root.dark) .article-heatmap {
    background: rgba(255, 255, 255, 0.05);
  }

  .heatmap-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    gap: 1rem;
  }

  .heatmap-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .heatmap-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
  }

  .heatmap-legend {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-secondary, #666);
  }

  .year-switch {
    display: inline-flex;
    gap: 0.5rem;
  }

  .year-btn {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    text-decoration: none;
    color: var(--color-text-secondary, #666);
    border: 1px solid rgba(0, 0, 0, 0.1);
    background: transparent;
  }

  :global(:root.dark) .year-btn {
    border-color: rgba(255, 255, 255, 0.2);
  }

  .year-btn:hover {
    color: var(--color-text, inherit);
    border-color: rgba(0, 0, 0, 0.25);
  }

  :global(:root.dark) .year-btn:hover {
    border-color: rgba(255, 255, 255, 0.35);
  }

  .legend-label {
    font-size: 0.75rem;
    color: var(--color-text-secondary, #999);
  }

  .legend-boxes {
    display: flex;
    gap: 0.25rem;
  }

  .legend-box {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 0.125rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .legend-box.intensity-0 {
    background-color: rgba(0, 0, 0, 0.05);
  }

  .legend-box.intensity-1 {
    background-color: #c6e48b;
  }

  .legend-box.intensity-2 {
    background-color: #7bc96f;
  }

  .legend-box.intensity-3 {
    background-color: #239a3b;
  }

  .legend-box.intensity-4 {
    background-color: #196127;
  }

  :global(:root.dark) .legend-box {
    border-color: rgba(255, 255, 255, 0.2);
  }

  :global(:root.dark) .legend-box.intensity-0 {
    background-color: rgba(255, 255, 255, 0.1);
  }

  :global(:root.dark) .legend-box.intensity-1 {
    background-color: #2d5016;
  }

  :global(:root.dark) .legend-box.intensity-2 {
    background-color: #26a641;
  }

  :global(:root.dark) .legend-box.intensity-3 {
    background-color: #1f6feb;
  }

  :global(:root.dark) .legend-box.intensity-4 {
    background-color: #58a6ff;
  }

  .heatmap-container {
    display: flex;
    gap: 1rem;
    overflow-x: visible;
    margin-bottom: 1rem;
  }

  .heatmap-labels {
    display: flex;
    align-items: flex-end;
  }

  .day-labels {
    display: grid;
    grid-template-rows: repeat(7, var(--heatmap-cell));
    gap: var(--heatmap-gap);
  }

  .day-label {
    font-size: 0.75rem;
    color: var(--color-text-secondary, #666);
    text-align: right;
    padding-right: var(--heatmap-label-pad);
    width: var(--heatmap-label-width);
  }

  .heatmap-wrapper {
    flex: 1;
    min-width: 0;
    --weeks: 53;
  }

  .month-labels {
    display: grid;
    grid-template-columns: repeat(var(--weeks), var(--heatmap-cell));
    gap: var(--heatmap-gap);
    margin-bottom: 0.5rem;
    padding-left: 0;
  }

  .month-label {
    font-size: 0.75rem;
    color: var(--color-text-secondary, #666);
    padding-left: 0.25rem;
  }

  .heatmap-grid {
    display: grid;
    grid-auto-flow: column;
    grid-template-rows: repeat(7, var(--heatmap-cell));
    grid-auto-columns: var(--heatmap-cell);
    gap: var(--heatmap-gap);
  }

  .heatmap-cell {
    width: var(--heatmap-cell);
    height: var(--heatmap-cell);
    border-radius: 0.125rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .heatmap-cell:hover {
    transform: scale(1.12);
    position: relative;
    z-index: 1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .heatmap-cell.intensity-0 {
    background-color: rgba(0, 0, 0, 0.05);
  }

  .heatmap-cell.intensity-1 {
    background-color: #c6e48b;
  }

  .heatmap-cell.intensity-2 {
    background-color: #7bc96f;
  }

  .heatmap-cell.intensity-3 {
    background-color: #239a3b;
  }

  .heatmap-cell.intensity-4 {
    background-color: #196127;
  }

  .heatmap-cell.outside-year {
    opacity: 0.3;
  }

  :global(:root.dark) .heatmap-cell {
    border-color: rgba(255, 255, 255, 0.2);
  }

  :global(:root.dark) .heatmap-cell.intensity-0 {
    background-color: rgba(255, 255, 255, 0.1);
  }

  :global(:root.dark) .heatmap-cell.intensity-1 {
    background-color: #2d5016;
  }

  :global(:root.dark) .heatmap-cell.intensity-2 {
    background-color: #26a641;
  }

  :global(:root.dark) .heatmap-cell.intensity-3 {
    background-color: #1f6feb;
  }

  :global(:root.dark) .heatmap-cell.intensity-4 {
    background-color: #58a6ff;
  }

  .heatmap-stats {
    display: flex;
    gap: 2rem;
    font-size: 0.875rem;
    color: var(--color-text-secondary, #666);
    padding-top: 1rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  :global(:root.dark) .heatmap-stats {
    border-top-color: rgba(255, 255, 255, 0.1);
  }
</style>
