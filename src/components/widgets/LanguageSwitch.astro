---
import Link from '~/components/base/Link.astro'
import { getRelativeLocaleUrl } from 'astro:i18n'

import { ensureTrailingSlash } from '~/utils/path'
import { getLocale, useTranslations } from '~/i18n/translate'

const locale = getLocale(Astro.currentLocale)
const t = useTranslations(locale)

const currentPathname = ensureTrailingSlash(Astro.url.pathname)
const currentLocaleRoot = ensureTrailingSlash(getRelativeLocaleUrl(locale, ''))

const pathWithinLocale = currentPathname.startsWith(currentLocaleRoot)
  ? currentPathname.slice(currentLocaleRoot.length)
  : currentPathname.replace(/^\/+/, '')

const normalizedPath = pathWithinLocale.replace(/^\/+/, '').replace(/\/+$/, '')

const targetLocale = locale === 'zh' ? 'en' : 'zh'
const targetHref = ensureTrailingSlash(
  getRelativeLocaleUrl(targetLocale, normalizedPath)
)

const shortLabel = targetLocale === 'en' ? 'EN' : 'ä¸­'
const title = `${t('a11y.languageSwitch')}: ${t(`lang.${targetLocale}`)}`
---

<Link
  class="inline-flex items-center gap-1 op-60 hover:op-100 op-transition"
  href={targetHref}
  {title}
  aria-label={title}
>
  <span u-i-ri-translate-2 aria-hidden="true"></span>
  <span class="text-sm font-500">{shortLabel}</span>
</Link>
