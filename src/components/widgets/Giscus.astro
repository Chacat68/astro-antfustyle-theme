---
import { getLocale } from '~/i18n/translate'
import { localeToGiscusLang } from '~/i18n/locale-meta'

const locale = getLocale(Astro.currentLocale)
const giscusLang = localeToGiscusLang(locale)
---

<div class="giscus" data-giscus-lang={giscusLang}></div>

<script>
  import { FEATURES } from '~/config'

  const giscusThemeLight = `${location.origin}/giscus/light.css`
  const giscusThemeDark = `${location.origin}/giscus/dark.css`

  const giscusConfig = Array.isArray(FEATURES.giscus) && FEATURES.giscus[1]
  const giscusTemplateScript = document.createElement('script')

  const giscusLang =
    document.querySelector<HTMLElement>('.giscus')?.dataset.giscusLang || 'en'

  Object.entries({
    ...giscusConfig,
    // Override config language per route locale
    'data-lang': giscusLang,
    ...{
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      crossOrigin: 'anonymous',
      // 'data-loading': 'lazy',
      async: '',
    },
  }).forEach(([key, value]) => {
    giscusTemplateScript.setAttribute(key, value)
  })

  const removeOldGiscus = () => {
    document
      .querySelectorAll('iframe.giscus-frame')
      .forEach((el) => el.remove())

    document
      .querySelectorAll('script#giscus-script')
      .forEach((el) => el.remove())
  }

  const addGiscusScript = () => {
    const container = document.querySelector('.giscus')
    if (!container) return

    // Always clone a fresh <script> to ensure it executes again;
    // reused or previously inserted scripts won't run
    const clonedScript = giscusTemplateScript.cloneNode(
      true
    ) as HTMLScriptElement
    clonedScript.setAttribute(
      'data-theme',
      document.documentElement.classList.contains('dark')
        ? giscusThemeDark
        : giscusThemeLight
    )
    container.appendChild(clonedScript)
  }

  document.addEventListener('astro:before-swap', removeOldGiscus)
  document.addEventListener('astro:page-load', addGiscusScript)
</script>
