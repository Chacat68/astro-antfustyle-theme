---
import LogoButton from '~/components/widgets/LogoButton.astro'
import Divider from '~/components/base/Divider.astro'
import SearchSwitch from '~/components/widgets/SearchSwitch.astro'
import LanguageSwitch from '~/components/widgets/LanguageSwitch.astro'
import ThemeSwitch from '~/components/widgets/ThemeSwitch.astro'
import RssLink from '~/components/widgets/RssLink.astro'
import NavItem from '~/components/nav/NavItem.astro'
import NavSwitch from '~/components/nav/NavSwitch.astro'

import { UI } from '~/config'
import { getLocale, useTranslations } from '~/i18n/translate'

const { navBarLayout, internalNavs, socialLinks } = UI
const { left, right, mergeOnMobile } = navBarLayout

const locale = getLocale(Astro.currentLocale)
const t = useTranslations(locale)

const navKeyByPath: Record<string, string> = {
  '/blog': 'nav.blog',
  '/projects': 'nav.projects',
  '/photos': 'nav.photos',
  '/changelog': 'nav.changelog',
}

const localizedInternalNavs = internalNavs.map((item) => {
  const key = navKeyByPath[item.path.replace(/\/+$/, '')]
  if (!key) return item
  return 'text' in item
    ? { ...item, title: t(key), text: t(key) }
    : { ...item, title: t(key) }
})

for (const item of new Set(left)) {
  if (new Set(right).has(item)) {
    throw new Error(
      `Duplicate '${item}' found in both 'UI.navBarLayout.left' and 'UI.navBarLayout.right'.`
    )
  }
}
---

<header
  class={`flex items-center gap-6 p-[1.75rem_2rem_2rem] ${mergeOnMobile ? 'lt-md:px-7' : 'lt-md:(px-6 gap-3)'}`}
>
  <LogoButton />
  <nav
    class={`flex items-center gap-4.8 w-full lt-md:justify-end
    ${left.length !== 0 ? (right.length !== 0 ? 'justify-between' : '') : 'justify-end'}`}
    aria-label={t('a11y.mainMenu')}
  >
    {
      left.length !== 0 && (
        <div
          class={`grid grid-flow-col items-center gap-4.8 print:op-0 ${mergeOnMobile ? '' : 'lt-md:(gap-3)'}`}
        >
          {left.map((key) =>
            key === 'hr' ? (
              <Divider class={mergeOnMobile ? 'lt-md:hidden' : undefined} />
            ) : key === 'searchButton' ? (
              <SearchSwitch />
            ) : key === 'langButton' ? (
              <LanguageSwitch />
            ) : key === 'themeButton' ? (
              <ThemeSwitch />
            ) : key === 'rssLink' ? (
              <RssLink class={mergeOnMobile ? 'lt-md:hidden' : undefined} />
            ) : key === 'internalNavs' ? (
              localizedInternalNavs.map((item) => (
                <NavItem type="internal" {item} {mergeOnMobile} />
              ))
            ) : (
              socialLinks.map((item) => (
                <NavItem type="social" {item} {mergeOnMobile} />
              ))
            )
          )}
        </div>
      )
    }
    {
      right.length !== 0 && (
        <div
          class={`grid grid-flow-col items-center gap-4.8 print:op-0
              ${!right.includes('themeButton') && !right.includes('searchButton') && 'lt-md:hidden'}
              ${mergeOnMobile ? '' : 'lt-md:(gap-3)'}`}
        >
          {right.map((key) =>
            key === 'hr' ? (
              <Divider class={mergeOnMobile ? 'lt-md:hidden' : undefined} />
            ) : key === 'searchButton' ? (
              <SearchSwitch />
            ) : key === 'langButton' ? (
              <LanguageSwitch />
            ) : key === 'themeButton' ? (
              <ThemeSwitch />
            ) : key === 'rssLink' ? (
              <RssLink class={mergeOnMobile ? 'lt-md:hidden' : undefined} />
            ) : key === 'internalNavs' ? (
              localizedInternalNavs.map((item) => (
                <NavItem type="internal" {item} {mergeOnMobile} />
              ))
            ) : (
              socialLinks.map((item) => (
                <NavItem type="social" {item} {mergeOnMobile} />
              ))
            )
          )}
        </div>
      )
    }
    {
      mergeOnMobile && (
        <NavSwitch>
          <Fragment slot="text">
            {localizedInternalNavs.length !== 0 &&
              localizedInternalNavs.map((item) => (
                <NavItem
                  type="internal"
                  {item}
                  {mergeOnMobile}
                  mobileItemType="text"
                />
              ))}
            {socialLinks.length !== 0 &&
              socialLinks.map((item) => (
                <NavItem
                  type="social"
                  {item}
                  {mergeOnMobile}
                  mobileItemType="text"
                />
              ))}
          </Fragment>
          <Fragment slot="icon">
            {localizedInternalNavs.length !== 0 &&
              localizedInternalNavs.map((item) => (
                <NavItem
                  type="internal"
                  {item}
                  {mergeOnMobile}
                  mobileItemType="icon"
                />
              ))}
            {socialLinks.length !== 0 &&
              socialLinks.map((item) => (
                <NavItem
                  type="social"
                  {item}
                  {mergeOnMobile}
                  mobileItemType="icon"
                />
              ))}
            <LanguageSwitch />
            <RssLink class="op-50!" />
          </Fragment>
        </NavSwitch>
      )
    }
  </nav>
</header>
